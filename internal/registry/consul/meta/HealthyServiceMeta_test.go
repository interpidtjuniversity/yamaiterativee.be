package meta

import (
	"encoding/json"
	"github.com/stretchr/testify/assert"
	"testing"
)

func Test_Unmarshal(t *testing.T) {
	h := make([]HealthyServiceMeta, 1)
	source := []byte("[{\"Node\":{\"ID\":\"b19b3654-e93a-0642-9ecc-a7be7bacee08\",\"Node\":\"GLOBAL_CONSUL\",\"Address\":\"172.16.1.2\",\"Datacenter\":\"global_consul\",\"TaggedAddresses\":{\"lan\":\"172.16.1.2\",\"wan\":\"172.16.1.2\"},\"Meta\":{\"consul-network-segment\":\"\"},\"CreateIndex\":5,\"ModifyIndex\":20},\"Service\":{\"ID\":\"instance-0edef0abb19f11eb9274-interpidtjuniversity-miniselfop-dev\",\"Service\":\"interpidtjuniversity-miniselfop\",\"Tags\":[\"dev\"],\"Address\":\"10.0.0.2\",\"Meta\":{\"gRPC_port\":\"9090\",\"secure\":\"false\"},\"Port\":10000,\"Weights\":{\"Passing\":1,\"Warning\":1},\"EnableTagOverride\":false,\"ProxyDestination\":\"\",\"Proxy\":{},\"Connect\":{},\"CreateIndex\":96,\"ModifyIndex\":96},\"Checks\":[{\"Node\":\"GLOBAL_CONSUL\",\"CheckID\":\"serfHealth\",\"Name\":\"Serf Health Status\",\"Status\":\"passing\",\"Notes\":\"\",\"Output\":\"Agent alive and reachable\",\"ServiceID\":\"\",\"ServiceName\":\"\",\"ServiceTags\":[],\"Definition\":{},\"CreateIndex\":19,\"ModifyIndex\":19},{\"Node\":\"GLOBAL_CONSUL\",\"CheckID\":\"service:instance-0edef0abb19f11eb9274-interpidtjuniversity-miniselfop-dev\",\"Name\":\"Service 'interpidtjuniversity-miniselfop' check\",\"Status\":\"passing\",\"Notes\":\"\",\"Output\":\"HTTP GET http://10.0.0.2:8088/actuator/health: 200  Output: {\\\"status\\\":\\\"UP\\\",\\\"components\\\":{\\\"consul\\\":{\\\"status\\\":\\\"UP\\\",\\\"details\\\":{\\\"leader\\\":\\\"172.16.1.2:8300\\\",\\\"services\\\":{\\\"consul\\\":[],\\\"interpidtjuniversity-miniselfop\\\":[\\\"dev\\\"],\\\"interpidtjuniversity-miniselfop-management\\\":[\\\"management\\\"],\\\"miniselfop-client-dev\\\":[]}}},\\\"discoveryComposite\\\":{\\\"status\\\":\\\"UP\\\",\\\"components\\\":{\\\"discoveryClient\\\":{\\\"status\\\":\\\"UP\\\",\\\"details\\\":{\\\"services\\\":[\\\"consul\\\",\\\"interpidtjuniversity-miniselfop\\\",\\\"interpidtjuniversity-miniselfop-management\\\",\\\"miniselfop-client-dev\\\"]}}}},\\\"diskSpace\\\":{\\\"status\\\":\\\"UP\\\",\\\"details\\\":{\\\"total\\\":124959473664,\\\"free\\\":54672912384,\\\"threshold\\\":10485760,\\\"exists\\\":true}},\\\"grpcChannel\\\":{\\\"status\\\":\\\"UP\\\"},\\\"ping\\\":{\\\"status\\\":\\\"UP\\\"},\\\"refreshScope\\\":{\\\"status\\\":\\\"UP\\\"}}}\",\"ServiceID\":\"instance-0edef0abb19f11eb9274-interpidtjuniversity-miniselfop-dev\",\"ServiceName\":\"interpidtjuniversity-miniselfop\",\"ServiceTags\":[\"dev\"],\"Definition\":{},\"CreateIndex\":96,\"ModifyIndex\":1427}]},{\"Node\":{\"ID\":\"b19b3654-e93a-0642-9ecc-a7be7bacee08\",\"Node\":\"GLOBAL_CONSUL\",\"Address\":\"172.16.1.2\",\"Datacenter\":\"global_consul\",\"TaggedAddresses\":{\"lan\":\"172.16.1.2\",\"wan\":\"172.16.1.2\"},\"Meta\":{\"consul-network-segment\":\"\"},\"CreateIndex\":5,\"ModifyIndex\":20},\"Service\":{\"ID\":\"instance-24391683b27111eba6c5-interpidtjuniversity-miniselfop-dev\",\"Service\":\"interpidtjuniversity-miniselfop\",\"Tags\":[\"dev\"],\"Address\":\"10.0.0.3\",\"Meta\":{\"gRPC_port\":\"9090\",\"secure\":\"false\"},\"Port\":10000,\"Weights\":{\"Passing\":1,\"Warning\":1},\"EnableTagOverride\":false,\"ProxyDestination\":\"\",\"Proxy\":{},\"Connect\":{},\"CreateIndex\":105,\"ModifyIndex\":105},\"Checks\":[{\"Node\":\"GLOBAL_CONSUL\",\"CheckID\":\"serfHealth\",\"Name\":\"Serf Health Status\",\"Status\":\"passing\",\"Notes\":\"\",\"Output\":\"Agent alive and reachable\",\"ServiceID\":\"\",\"ServiceName\":\"\",\"ServiceTags\":[],\"Definition\":{},\"CreateIndex\":19,\"ModifyIndex\":19},{\"Node\":\"GLOBAL_CONSUL\",\"CheckID\":\"service:instance-24391683b27111eba6c5-interpidtjuniversity-miniselfop-dev\",\"Name\":\"Service 'interpidtjuniversity-miniselfop' check\",\"Status\":\"critical\",\"Notes\":\"\",\"Output\":\"Get http://10.0.0.3:8088/actuator/health: dial tcp 10.0.0.3:8088: connect: connection refused\",\"ServiceID\":\"instance-24391683b27111eba6c5-interpidtjuniversity-miniselfop-dev\",\"ServiceName\":\"interpidtjuniversity-miniselfop\",\"ServiceTags\":[\"dev\"],\"Definition\":{},\"CreateIndex\":105,\"ModifyIndex\":235}]}]")
	err := json.Unmarshal(source, &h)
	assert.Nil(t, err)
	data, err := json.Marshal(h)
	assert.Equal(t, data, source)
}
